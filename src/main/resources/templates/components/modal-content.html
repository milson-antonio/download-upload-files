<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <div th:fragment="editFragment">
        <div class="modal-header">
            <h5 class="modal-title">Edit File</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body">
            <form id="editFileForm" th:attr="hx-put=@{/update/{id}(id=${file.id})}" hx-target="#table-container" hx-swap="outerHTML">
                <input type="hidden" id="fileId" name="id" th:value="${file.id}">
                <div class="form-group row">
                    <label for="name" class="col-sm-3 col-form-label">File Name:</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="name" name="name" th:value="${file.originalFilename}">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="category" class="col-sm-3 col-form-label">Category:</label>
                    <div class="col-sm-9">
                        <select class="form-control" id="category" name="category">
                            <option value="">Select a category</option>
                            <option th:each="cat : ${categories}" 
                                    th:value="${cat}"
                                    th:text="${cat}" 
                                    th:selected="${cat == file.category.description}">
                            </option>
                        </select>
                    </div>
                </div>
                <div id="updateMessage" class="alert" style="display: none;"></div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary mx-2" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary mx-2">Save</button>
                </div>
            </form>

            <!-- js script to close model after send update request-->
            <script>
                document.getElementById('editFileForm').addEventListener('submit', function() {
                    const overlay = document.getElementById('overlay');
                    overlay.style.display = 'flex'; // Show the overlay with spinner
                    document.getElementById('table-container').classList.add('disabled');
                    document.getElementById("table-container").style.pointerEvents = "none";
                });

                document.getElementById('editFileForm').addEventListener('htmx:afterRequest', function(event) {
                    if (event.detail.successful) {
                        $('#editModal').modal('hide');

                        // Use setTimeout to ensure this runs after the DOM has been updated
                        setTimeout(function() {
                            // Ensure overlay is hidden after successful update
                            const overlay = document.getElementById('overlay');
                            if (overlay) {
                                overlay.style.display = 'none';
                            }

                            // Remove disabled class and restore pointer events
                            const tableContainer = document.getElementById('table-container');
                            if (tableContainer) {
                                tableContainer.classList.remove('disabled');
                                tableContainer.style.pointerEvents = "auto";
                            }

                            // Force any background overlay to be removed
                            document.body.style.overflow = 'auto';
                            document.body.style.paddingRight = '0';
                        }, 100); // Small delay to ensure DOM is updated
                    }
                });
            </script>

        </div>
    </div>
</body>
</html>
